<template>
    <div
        style="width: 100%; height: 100%; border-radius: 10px; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 50px; display: inline-flex">
        <div
            style="min-height: 154px; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 30px; display: flex;width:100%">
            <div
                style="width: 100%; height: 60px; padding-top: 10px; padding-bottom: 10px; background: #EFF2FE; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 20px; display: inline-flex">
                <div
                    style="width: 100%; justify-content: center; align-items: flex-start; gap: 569px; display: inline-flex">
                    <div
                        style="width: 100%; align-self: stretch; justify-content: flex-start; align-items: center; gap: 10px; display: flex">
                        <div style="width: 40px; height: 40px; position: relative">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"
                                fill="none">
                                <path
                                    d="M5.58813 14.9174C6.67396 10.2883 10.2883 6.67395 14.9174 5.58813C18.2604 4.80396 21.7396 4.80396 25.0826 5.58813C29.7117 6.67395 33.326 10.2883 34.4119 14.9174C35.196 18.2604 35.196 21.7396 34.4119 25.0826C33.326 29.7117 29.7117 33.326 25.0826 34.4119C21.7396 35.196 18.2604 35.196 14.9174 34.4119C10.2884 33.326 6.67396 29.7117 5.58813 25.0826C4.80396 21.7396 4.80396 18.2604 5.58813 14.9174Z"
                                    fill="#EFF2FE" stroke="#5063F4" stroke-width="1.35" stroke-linecap="round" />
                                <path
                                    d="M24.875 13L13 24.8758L14.5802 26.456L26.4552 14.581L24.875 13ZM23.6891 21.3125C24.001 21.3128 24.3097 21.3746 24.5978 21.4942C24.8858 21.6138 25.1474 21.789 25.3678 22.0098C25.5881 22.2306 25.7628 22.4926 25.8818 22.7808C26.0009 23.0691 26.062 23.378 26.0617 23.6899C26.0614 24.0018 25.9997 24.3105 25.88 24.5986C25.7604 24.8866 25.5852 25.1482 25.3644 25.3686C25.1436 25.5889 24.8817 25.7636 24.5934 25.8826C24.3051 26.0017 23.9962 26.0628 23.6843 26.0625C23.0544 26.0619 22.4506 25.811 22.0057 25.3652C21.5607 24.9194 21.3111 24.315 21.3117 23.6851C21.3123 23.0552 21.5632 22.4514 22.009 22.0064C22.4549 21.5615 23.0592 21.3119 23.6891 21.3125ZM23.6867 22.8958C23.4767 22.8958 23.2754 22.9792 23.1269 23.1277C22.9784 23.2762 22.895 23.4775 22.895 23.6875C22.895 23.8975 22.9784 24.0988 23.1269 24.2473C23.2754 24.3958 23.4767 24.4792 23.6867 24.4792C23.8967 24.4792 24.098 24.3958 24.2465 24.2473C24.395 24.0988 24.4784 23.8975 24.4784 23.6875C24.4784 23.4775 24.395 23.2762 24.2465 23.1277C24.098 22.9792 23.8967 22.8958 23.6867 22.8958ZM15.7724 13.3958C16.4023 13.3965 17.0061 13.6473 17.4511 14.0931C17.8961 14.539 18.1457 15.1433 18.145 15.7732C18.1444 16.4031 17.8936 17.0069 17.4477 17.4519C17.0019 17.8968 16.3976 18.1465 15.7677 18.1458C15.1378 18.1452 14.5339 17.8944 14.089 17.4485C13.644 17.0027 13.3944 16.3983 13.395 15.7685C13.3957 15.1386 13.6465 14.5347 14.0923 14.0898C14.5382 13.6448 15.1425 13.3952 15.7724 13.3958ZM15.77 14.9792C15.5601 14.9792 15.3587 15.0626 15.2102 15.211C15.0618 15.3595 14.9784 15.5609 14.9784 15.7708C14.9784 15.9808 15.0618 16.1822 15.2102 16.3306C15.3587 16.4791 15.5601 16.5625 15.77 16.5625C15.98 16.5625 16.1814 16.4791 16.3298 16.3306C16.4783 16.1822 16.5617 15.9808 16.5617 15.7708C16.5617 15.5609 16.4783 15.3595 16.3298 15.211C16.1814 15.0626 15.98 14.9792 15.77 14.9792Z"
                                    fill="#5063F4" />
                            </svg>
                        </div>
                        <div
                            style="color: #252525; font-size: 30px;  font-weight: 800; line-height: 32px; word-wrap: break-word">
                            Campaign and Produts Rates Summary</div>
                    </div>
                </div>
            </div>
            <div
                style="flex-direction: column; justify-content: center; align-items: flex-start; gap: 10px; display: flex; width: 90%;">
                <table class="table" style="background: transparent">
                    <thead class="customHeader1" style="background: transparent;border-collapse: collapse;">
                        <tr style="border: none!important;">
                            <th>Campaign Name</th>
                            <th>Products</th>
                            <th>Currency</th>
                            <th>Subscription Limit</th>
                            <th>Invitees</th>
                            <th>Start Date</th>
                            <th>Expiry Date</th>
                        </tr>
                    </thead>
                    <tbody class="customBody1" style="background: transparent;border-collapse: collapse;">
                        <tr style="border: none!important;">
                            <td>{{ collected_details_data?.campaign_name }}</td>
                            <td>{{ getCampaignSelectedProducts?.length }}</td>
                            <td>{{ collected_details_data?.currency }}</td>
                            <td>{{ addCommans(collected_details_data?.subscription_amount) }}</td>
                            <!-- <td v-if="type_of_invite=1">{{ selected_organizations?.length }}</td> -->
                            <td>{{ depos_count }}</td>
                            <td>{{ collected_details_data?.start_date }}</td>
                            <td>{{ collected_details_data?.expiry_date }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div style="width: 100%">
            <table class="table table-vue-custom">
                <thead class="customHeader" style="background: transparent">
                    <tr>
                        <th>Product&nbsp;Name</th>
                        <th>Lockout/Notice&nbsp;Period(Days)</th>
                        <th>Term&nbsp;Length</th>
                        <!--                        <th>Rate&nbsp;Type</th>-->
                        <!--                        <th>Index&nbsp;Rate</th>-->
                        <!--                        <th>-->
                        <!--                            <div style="display: flex; flex-direction: row; gap: 5px; justify-content: center">-->
                        <!--                                Spread-->
                        <!--                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="17" viewBox="0 0 16 17" fill="none" id="spread_rate">-->
                        <!--                                    <path d="M6.06016 6.50016C6.2169 6.05461 6.52626 5.6789 6.93347 5.43958C7.34067 5.20027 7.81943 5.11279 8.28495 5.19264C8.75047 5.27249 9.17271 5.51451 9.47688 5.87585C9.78106 6.23718 9.94753 6.69451 9.94683 7.16683C9.94683 8.50016 7.94683 9.16683 7.94683 9.16683M8.00016 11.8335H8.00683M14.6668 8.50016C14.6668 12.1821 11.6821 15.1668 8.00016 15.1668C4.31826 15.1668 1.3335 12.1821 1.3335 8.50016C1.3335 4.81826 4.31826 1.8335 8.00016 1.8335C11.6821 1.8335 14.6668 4.81826 14.6668 8.50016Z" stroke="#5063F4" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>-->
                        <!--                                </svg>-->
                        <!--                                <Tooltip placement="top" target="spread_rate" message="Add negative sign for negative spreads e.g -0.25%" />-->
                        <!--                            </div>-->
                        <th>Rate (%)</th>
                        <th>Minimum ({{ collected_details_data?.currency }})</th>
                        <th>Maximum ({{ collected_details_data?.currency }})</th>
                        <!-- <th>Order&nbsp;Limit</th> -->
                        <th>
                            <div style="display: flex; flex-direction: row; gap: 5px">
                                PDS
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="17" viewBox="0 0 16 17"
                                    fill="none" id="pds">
                                    <path
                                        d="M6.06016 6.50016C6.2169 6.05461 6.52626 5.6789 6.93347 5.43958C7.34067 5.20027 7.81943 5.11279 8.28495 5.19264C8.75047 5.27249 9.17271 5.51451 9.47688 5.87585C9.78106 6.23718 9.94753 6.69451 9.94683 7.16683C9.94683 8.50016 7.94683 9.16683 7.94683 9.16683M8.00016 11.8335H8.00683M14.6668 8.50016C14.6668 12.1821 11.6821 15.1668 8.00016 15.1668C4.31826 15.1668 1.3335 12.1821 1.3335 8.50016C1.3335 4.81826 4.31826 1.8335 8.00016 1.8335C11.6821 1.8335 14.6668 4.81826 14.6668 8.50016Z"
                                        stroke="#5063F4" stroke-width="1.33333" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                                <Tooltip placement="top" target="pds" message="Product disclosure statement" />
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody class="">
                    <tr v-if="products_data" v-for="(product, index) in getCampaignSelectedProducts"
                        style="border-bottom: 1 px solid rgb(238, 233, 233);">
                        <td>{{ capitalize(product.product_name) }}</td>

                        <td>{{ (product?.product_type?.description === "Cashable" ||
                            product?.product_type?.description === "Notice Deposit") ?
                            product?.lockout_period : " - " }} </td>
                        <td> {{ product.term_length }} <span style="color:grey;"> ({{
                                capitalize(product.term_length_type) }})</span></td>
                        <td>{{product.rate}}</td>
                        <td>{{addCommans(product.minimum) }}</td>
                        <td>{{addCommans(product.maximum) }}</td>
                        <!-- <td>{{ getProductOrderLimit(getProductInfo(product.id)) }}</td> -->
                        <td>
                            <div v-if="product.pds">
                                <a :href="'/uploads/pds/' + product.pds" target="_blank" v-if="product.pds">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"
                                        fill="none" style="cursor: pointer">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M3.33301 3.33341C3.33301 2.89139 3.5086 2.46746 3.82116 2.1549C4.13372 1.84234 4.55765 1.66675 4.99967 1.66675H14.9997C15.4417 1.66675 15.8656 1.84234 16.1782 2.1549C16.4907 2.46746 16.6663 2.89139 16.6663 3.33341V16.6667C16.6663 17.1088 16.4907 17.5327 16.1782 17.8453C15.8656 18.1578 15.4417 18.3334 14.9997 18.3334H4.99967C4.55765 18.3334 4.13372 18.1578 3.82116 17.8453C3.5086 17.5327 3.33301 17.1088 3.33301 16.6667V3.33341ZM14.9997 3.33341H4.99967V16.6667H14.9997V3.33341ZM6.66634 7.50008C6.66634 7.27907 6.75414 7.06711 6.91042 6.91083C7.0667 6.75455 7.27866 6.66675 7.49967 6.66675H12.4997C12.7207 6.66675 12.9326 6.75455 13.0889 6.91083C13.2452 7.06711 13.333 7.27907 13.333 7.50008C13.333 7.7211 13.2452 7.93306 13.0889 8.08934C12.9326 8.24562 12.7207 8.33341 12.4997 8.33341H7.49967C7.27866 8.33341 7.0667 8.24562 6.91042 8.08934C6.75414 7.93306 6.66634 7.7211 6.66634 7.50008ZM7.49967 10.8334C7.27866 10.8334 7.0667 10.9212 6.91042 11.0775C6.75414 11.2338 6.66634 11.4457 6.66634 11.6667C6.66634 11.8878 6.75414 12.0997 6.91042 12.256C7.0667 12.4123 7.27866 12.5001 7.49967 12.5001H9.99967C10.2207 12.5001 10.4326 12.4123 10.5889 12.256C10.7452 12.0997 10.833 11.8878 10.833 11.6667C10.833 11.4457 10.7452 11.2338 10.5889 11.0775C10.4326 10.9212 10.2207 10.8334 9.99967 10.8334H7.49967Z"
                                            fill="#5063F4" />
                                    </svg>
                                </a>
                            </div>

                            <div v-else>
                                -
                            </div>

                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div style="justify-content: flex-end; align-items: center; display: inline-flex;width: 100%">
            <div style="justify-content: flex-end; align-items: flex-start; gap: 50px; display: inline-flex">
                <b-button @click="$emit('back-step', 5)"
                    style="width:166px;  height: 40px !important;padding: 10px, 30px, 10px, 30px !important;border-radius: 20px !important;border: #9CA1AA 2px solid !important;background-color: #EFF2FE !important;color:#9CA1AA  !important;">
                    Previous
                </b-button>

                <b-button @click="submitRates()"
                    style=" width:166px;  height: 40px !important;padding: 10px, 30px, 10px, 30px !important;border-radius: 20px !important;border: 2px !important;background-color: #5063F4 !important;color: white !important;">
                    Next
                    <b-spinner variant="primary" label="Loading" v-if="submittedSaveDraft"
                        style="width: 1.3rem; height: 1.3rem;margin-right:5px">
                    </b-spinner>
                </b-button>
            </div>

        </div>

        <SuccessCampaign :campaign_name="its_campaign_name" :campaign_id="its_campaign_id"
            :show="success_campaign_show" />
    </div>
</template>
<style scoped>
    .table-vue-custom {
        background: white;
    }
</style>
<style scoped>
    thead.customHeader1 {
        background: none !important;
        height: 51px;
    }

    thead.customHeader {
        background: #EFF2FE !important;
        height: 51px;
    }

    thead.customHeader tr {
        border-bottom: 0 solid #b3b2b2 !important;
    }

    thead.customHeader tr th {
        background: inherit !important;
        text-align: left !important;
        border: none !important;
        color: #252525;
        font-size: 16px;
        font-weight: 700;
        word-wrap: break-word;
    }

    thead.customBody tr td {
        text-align: center !important;
    }

    tbody.customBody1>tr>td {
        background: inherit !important;
        text-align: left !important;
        border: none !important;
        color: #5063F4 !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        word-wrap: break-word;
    }

    thead.customHeader1>tr>th {
        background: inherit !important;
        text-align: left !important;
        border: none !important;
        color: #252525;
        font-size: 16px;
        font-weight: 700;
        word-wrap: break-word;
    }

    tbody tr td {
        font-size: 13px !important;
    }

    .term_length_custom>.form-control {
        max-width: 70px !important;
    }
</style>
<script>
    import Button from "../../shared/Buttons/Button";
    import Tooltip from "../../shared/Tooltip";
    import SuccessCampaign from "./SuccessCampaign";
    import { mapGetters } from 'vuex';
    import * as types from '../../../store/modules/campaigns/mutation-types.js';
    export default {
        mounted() {
            // console.log("this.getMyProducts()");
            // console.log(this.getMyProducts());
            this.getMyProducts();
        },
        props: ['selected_products', 'collected_details_data', 'selected_groups', 'selected_organizations', 'type_of_invite', 'isSavedDraftAlready', 'depos_count'],
        computed: {
            ...mapGetters('campaign', ['getCampaignSelectedProducts', 'getCampaignSelectedProductIDS', 'getSelectedProductAtribute']),
        },
        data() {
            console.log(this.products_data, "this.products_data");
            return {
                submittedSaveDraft: false,
                products_data: null,
                its_campaign_id: null,
                its_campaign_name: null,
                success_campaign_show: false
            };
        },
        components: {
            Button,
            Tooltip,
            SuccessCampaign
        },
        methods: {
            capitalize(thestring) {
                if (thestring != undefined) {
                    return thestring
                        .toLowerCase()
                        .split(' ')
                        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                }

            },
            addCommans(newvalue) {
                if (newvalue) {
                    return newvalue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                } else {
                    return 0;
                }

            },
            sanitizeAmount(val) {
                try {
                    return parseFloat(val.replace(",", "", val).replace(" ", "", val));
                } catch (e) {
                    return val;
                }
            },
            getProductMinimum(product) {

                return this.getSelectedProductAtribute(product, 'minimum');
                // return (product.minimum) ? product.minimum.toLocaleString() : '';
            },
            getProductMaximum(product) {
                return this.getSelectedProductAtribute(product, 'maximum');
                //  return (product.maximum) ? product?.maximum.toLocaleString() : '';
            },
            getProductOrderLimit(product) {
                return this.getSelectedProductAtribute(product, 'maximum');
                //  return (product.order_limit) ? product.order_limit.toLocaleString() : '';
            },
            getProductInfo(product_id, place_holder = true) {
                let d = this.selected_products.filter(item => item.product_id == product_id);
                if (d.length > 0) {
                    return d[0];
                }

                if (!place_holder) {
                    return null;
                }
                return {
                    'term_length': null,
                    'order_limit': null,
                    'maximum': null,
                    'minimum': null,
                    'term_length_type': null,
                    'rate': null,
                }
            },
            getMyProducts() {
                let this_ = this;
                let prod_ids = [];
                this.selected_products.forEach(e => {
                    let p = e?.fi_campaign_product_id;
                    if (p === undefined) {
                        p = e?.product_id;
                    }

                    if (p === undefined) {
                        p = e;
                    }
                    prod_ids.push(p);
                });
                axios.get("/campaigns/fi/my-products?product_ids=" + prod_ids)
                    .then(response => {
                        this_.products_data = response?.data?.data;
                    }).catch(error => {
                        this_.products_data = null;
                    });
            },
            submitRates() {
                this.saveAsDraft(true);
            },
            saveAsDraft(isFinal = false) {
                if (this.submittedSaveDraft) {
                    return;
                }

                let groups_ = [];
                if (this.selected_groups) {
                    this.selected_groups.forEach((e) => {
                        let p = e?.fi_campaign_group_id;
                        if (p === undefined) {
                            p = e;
                        }

                        if (p) {
                            groups_.push(p);
                        }
                    });
                }

                const urlParams = new URLSearchParams(window.location.search);
                let campaign_id = urlParams.get('campaign_id');

                this.submittedSaveDraft = true;
                let this_ = this;

                if (this.isSavedDraftAlready > 0) {
                    campaign_id = this.isSavedDraftAlready;
                }
                axios.post(campaign_id ? '/campaigns/fi/update-campaign' : '/campaigns/fi/create-campaign', {
                    'campaignName': this.collected_details_data.campaign_name,
                    'expiryDate': this.collected_details_data.expiry_date,
                    'startDate': this.collected_details_data.start_date,
                    'currency': this.collected_details_data.currency,
                    'subscriptionAmount': this.collected_details_data.subscription_amount,
                    'status': isFinal ? 'SCHEDULED' : 'DRAFT',
                    'products': this.selected_products,
                    'campaign': campaign_id,
                    'groups': groups_,
                    'is_final_create_stage': isFinal && !campaign_id,
                    'type_of_invite': this.type_of_invite,
                    'selected_organizations': this.selected_organizations
                })
                    .then(response => {
                        this.submittedSaveDraft = false;
                        if (response?.data?.success) {
                            if (isFinal) { // move to the next page
                                this_.its_campaign_id = response?.data?.data?.id;
                                this_.its_campaign_name = response?.data?.data?.campaign_name;

                                this_.success_campaign_show = true;
                            } else {

                                this.$swal({
                                    title: 'Save as draft.',
                                    text: response?.data?.message,
                                    confirmButtonText: 'Close'
                                }).then(res => {

                                });

                            }
                        } else {
                            throw new Error(response?.data?.message);
                        }
                    }).catch(error => {
                        this.$swal({
                            title: isFinal ? 'Campaign submitted' : 'Save as draft.',
                            text: error,
                            confirmButtonText: 'Close'
                        });
                        this.submittedSaveDraft = false;
                    });
            },
        }
    }
</script>